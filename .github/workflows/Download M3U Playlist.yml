name: Download M3U Playlist

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    # æ¯å¤©å‡Œæ™¨3ç‚¹è‡ªåŠ¨æ‰§è¡Œï¼ˆUTCæ—¶é—´ï¼‰
    - cron: '0 3 * * *'
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/download-m3u.yml'

# è®¾ç½®å†™å…¥æƒé™
permissions:
  contents: write

jobs:
  download-m3u:
    runs-on: ubuntu-latest
    
    steps:
    # æ­¥éª¤1ï¼šæ£€å‡ºä»“åº“ï¼ˆä½¿ç”¨å…·æœ‰å†™å…¥æƒé™çš„tokenï¼‰
    - name: Checkout repository with write access
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0  # è·å–å®Œæ•´å†å²
    
    # æ­¥éª¤2ï¼šä¸‹è½½M3Uæ–‡ä»¶
    - name: Download M3U playlist
      id: download
      run: |
        echo "å¼€å§‹ä¸‹è½½M3Uæ’­æ”¾åˆ—è¡¨..."
        
        # ä¸‹è½½æ–‡ä»¶
        curl -s -L --max-time 30 \
          "http://zizi.dpdns.org/cs.php?key=Ku0VIKlbNHX9&type=m3u" \
          -o live.m3u
          
        # æ£€æŸ¥æ˜¯å¦ä¸‹è½½æˆåŠŸ
        if [ -f "live.m3u" ]; then
          # è®¾ç½®æ–‡ä»¶æƒé™
          chmod 664 live.m3u
          
          # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
          echo "âœ… ä¸‹è½½æˆåŠŸï¼"
          echo "æ–‡ä»¶å¤§å°: $(wc -l < live.m3u) è¡Œ"
          echo "æ–‡ä»¶æƒé™: $(stat -c "%a" live.m3u)"
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºç©º
          if [ ! -s "live.m3u" ]; then
            echo "âš ï¸ è­¦å‘Šï¼šæ–‡ä»¶ä¸ºç©ºï¼"
          fi
        else
          echo "âŒ ä¸‹è½½å¤±è´¥"
          exit 1
        fi
    
    # æ­¥éª¤3ï¼šé…ç½®Git
    - name: Setup Git
      run: |
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
    
    # æ­¥éª¤4ï¼šæ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
    - name: Check for changes
      id: check-changes
      run: |
        echo "æ£€æŸ¥æ–‡ä»¶å˜åŒ–..."
        
        # æ˜¾ç¤ºå½“å‰gitçŠ¶æ€
        git status
        
        # æ£€æŸ¥live.m3uæ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨
        if [ -f "live.m3u" ]; then
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æ˜¯æ–°æ–‡ä»¶æˆ–è¢«ä¿®æ”¹
          if ! git diff --quiet live.m3u 2>/dev/null; then
            echo "æ£€æµ‹åˆ°live.m3uæœ‰å˜åŒ–"
            echo "changes_detected=true" >> $GITHUB_OUTPUT
          elif ! git ls-files --error-unmatch live.m3u >/dev/null 2>&1; then
            echo "live.m3uæ˜¯æ–°æ–‡ä»¶"
            echo "changes_detected=true" >> $GITHUB_OUTPUT
          else
            echo "live.m3uæ²¡æœ‰å˜åŒ–"
            echo "changes_detected=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "live.m3uæ–‡ä»¶ä¸å­˜åœ¨"
          echo "changes_detected=false" >> $GITHUB_OUTPUT
        fi
    
    # æ­¥éª¤5ï¼šæäº¤å¹¶æ¨é€æ›´æ”¹
    - name: Commit and push changes
      if: steps.check-changes.outputs.changes_detected == 'true'
      run: |
        echo "æäº¤æ›´æ”¹..."
        
        # æ·»åŠ æ–‡ä»¶åˆ°æš‚å­˜åŒº
        git add live.m3u
        
        # æäº¤æ›´æ”¹
        COMMIT_MESSAGE="æ›´æ–°M3Uæ’­æ”¾åˆ—è¡¨ - $(date '+%Y-%m-%d %H:%M:%S')"
        git commit -m "$COMMIT_MESSAGE"
        
        # æ¨é€åˆ°ä»“åº“
        echo "æ­£åœ¨æ¨é€åˆ°ä»“åº“..."
        git push
        
        echo "âœ… æ›´æ”¹å·²æˆåŠŸæ¨é€ï¼"
    
    # æ­¥éª¤6ï¼šå¦‚æœæ²¡æœ‰å˜åŒ–
    - name: No changes to commit
      if: steps.check-changes.outputs.changes_detected == 'false'
      run: |
        echo "ğŸ“ æ²¡æœ‰æ£€æµ‹åˆ°å˜åŒ–ï¼Œè·³è¿‡æäº¤"
        echo "å½“å‰æ–‡ä»¶çŠ¶æ€:"
        git status --short
        
    # æ­¥éª¤7ï¼šéªŒè¯æ–‡ä»¶å·²åˆ›å»º
    - name: Verify file creation
      run: |
        echo "éªŒè¯æ–‡ä»¶çŠ¶æ€..."
        echo "å½“å‰ç›®å½•:"
        ls -la
        echo "live.m3uè¯¦æƒ…:"
        if [ -f "live.m3u" ]; then
          ls -la live.m3u
          echo "æ–‡ä»¶å†…å®¹é¢„è§ˆï¼ˆå‰5è¡Œï¼‰:"
          head -5 live.m3u
        else
          echo "âŒ live.m3uæ–‡ä»¶ä¸å­˜åœ¨"
        fi
