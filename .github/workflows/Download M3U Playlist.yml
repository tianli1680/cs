name: Download and Filter M3U Playlist

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    # æ¯å¤©å‡Œæ™¨3ç‚¹è‡ªåŠ¨æ‰§è¡Œï¼ˆUTCæ—¶é—´ï¼‰
    - cron: '0 3 * * *'
  push:
åˆ†æ”¯: [ main, master ]
    paths:
      - '.github/workflows/download-m3u.yml'

permissions:
  contents: write

jobs:
  download-and-filter:
    runs-on: ubuntu-latest
    
    steps:
    # æ­¥éª¤1ï¼šæ£€å‡ºä»“åº“
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    # æ­¥éª¤2ï¼šä¸‹è½½åŸå§‹M3Uæ–‡ä»¶
    - name: Download M3U playlist
      id: download
      run: |
        echo "å¼€å§‹ä¸‹è½½åŸå§‹M3Uæ’­æ”¾åˆ—è¡¨..."
        
        # ä¸‹è½½æ–‡ä»¶
        curl -s -L --max-time 30 \
          "http://zizi.dpdns.org/cs.php?key=Ku0VIKlbNHX9&type=m3u" \
          -o raw_live.m3u
          
        # æ£€æŸ¥æ˜¯å¦ä¸‹è½½æˆåŠŸ
        if [ -f "raw_live.m3u" ]; then
          # è®¾ç½®æ–‡ä»¶æƒé™
          chmod 664 raw_live.m3u
          
          # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
          echo "âœ… åŸå§‹æ–‡ä»¶ä¸‹è½½æˆåŠŸï¼"
          echo "åŸå§‹æ–‡ä»¶å¤§å°: $(wc -l < raw_live.m3u) è¡Œ"
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºç©º
          if [ ! -s "raw_live.m3u" ]; then
            echo "âš ï¸ è­¦å‘Šï¼šåŸå§‹æ–‡ä»¶ä¸ºç©ºï¼"
            exit 1
          fi
        else
          echo "âŒ åŸå§‹æ–‡ä»¶ä¸‹è½½å¤±è´¥"
          exit 1
        fi
    
    # æ­¥éª¤3ï¼šç­›é€‰å«è§†é¢‘é“
    - name: Filter satellite TV channels
      id: filter
      run: |
        echo "å¼€å§‹ç­›é€‰å«è§†é¢‘é“..."
        
        # å®šä¹‰è¦ç­›é€‰çš„å…³é”®è¯ï¼ˆå«è§†ç›¸å…³ï¼‰
        KEYWORDS="å«è§†|CCTV|æ¹–å—å«è§†|æµ™æ±Ÿå«è§†|æ±Ÿè‹å«è§†|ä¸œæ–¹å«è§†|åŒ—äº¬å«è§†|å¹¿ä¸œå«è§†|æ·±åœ³å«è§†|å®‰å¾½å«è§†|å±±ä¸œå«è§†|å¤©æ´¥å«è§†|æ¹–åŒ—å«è§†|é‡åº†å«è§†|å››å·å«è§†|é»‘é¾™æ±Ÿå«è§†|å‰æ—å«è§†|è¾½å®å«è§†|æ²³å—å«è§†|ä¸œå—å«è§†|æ±Ÿè¥¿å«è§†|å¹¿è¥¿å«è§†|è´µå·å«è§†|äº‘å—å«è§†|å±±è¥¿å«è§†|é™•è¥¿å«è§†|ç”˜è‚ƒå«è§†|é’æµ·å«è§†|å®å¤å«è§†|æ–°ç–†å«è§†|è¥¿è—å«è§†|å†…è’™å¤å«è§†|æ²³åŒ—å«è§†|æµ·å—å«è§†"
        
        # æ˜¾ç¤ºåŸå§‹æ–‡ä»¶åŸºæœ¬ä¿¡æ¯
        echo "åŸå§‹æ–‡ä»¶å‰5è¡Œ:"
        head -5 raw_live.m3u
        
        # ç­›é€‰åŒ…å«å«è§†å…³é”®è¯çš„é¢‘é“
        echo "æ­£åœ¨ç­›é€‰åŒ…å«å«è§†å…³é”®è¯çš„é¢‘é“..."
        
        # åˆ›å»ºæ–°çš„M3Uæ–‡ä»¶ï¼Œä¿ç•™M3Uå¤´éƒ¨ä¿¡æ¯
        echo "#EXTM3U" > live.m3u
        
        # ä½¿ç”¨grepç­›é€‰åŒ…å«å«è§†å…³é”®è¯çš„è¡Œï¼Œå¹¶ä¿ç•™æ•´ä¸ªé¢‘é“å—
        # M3Uæ ¼å¼é€šå¸¸æ˜¯ä¸€ä¸ªEXTINFè¡Œè·Ÿç€ä¸€ä¸ªURLè¡Œ
        grep -i -E "$KEYWORDS" -A 1 -B 0 raw_live.m3u >> live.m3u
        
        # å¦ä¸€ç§æ›´ç²¾ç¡®çš„æ–¹æ³•ï¼šé€è¡Œå¤„ç†ï¼Œä¿ç•™å®Œæ•´çš„é¢‘é“ä¿¡æ¯
        echo "ä½¿ç”¨ç²¾ç¡®ç­›é€‰æ–¹æ³•..."
        awk 'BEGIN {RS="#EXTINF"; ORS="#EXTINF"} /'"$KEYWORDS"'/ {print}' raw_live.m3u | grep -v "^$" > temp.m3u
        if [ -s "temp.m3u" ]; then
          echo "#EXTM3U" > live.m3u
          cat temp.m3u >> live.m3u
        fi
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -f temp.m3u
        
        # æ£€æŸ¥ç­›é€‰ç»“æœ
        if [ -f "live.m3u" ] && [ -s "live.m3u" ]; then
          # è®¾ç½®æ–‡ä»¶æƒé™
          chmod 664 live.m3u
          
          # ç»Ÿè®¡ä¿¡æ¯
          ORIGINAL_COUNT=$(grep -c "^#EXTINF" raw_live.m3u || echo "0")
          FILTERED_COUNT=$(grep -c "^#EXTINF" live.m3u || echo "0")
          
          echo "âœ… ç­›é€‰å®Œæˆï¼"
          echo "åŸå§‹é¢‘é“æ•°: $ORIGINAL_COUNT"
          echo "ç­›é€‰åé¢‘é“æ•°: $FILTERED_COUNT"
          
          # æ˜¾ç¤ºç­›é€‰åçš„é¢‘é“åˆ—è¡¨
          echo "ç­›é€‰å‡ºçš„é¢‘é“åˆ—è¡¨:"
          grep -i "^#EXTINF.*:" live.m3u | head -20
          
          if [ $FILTERED_COUNT -eq 0 ]; then
            echo "âš ï¸ è­¦å‘Šï¼šæ²¡æœ‰ç­›é€‰åˆ°ä»»ä½•å«è§†é¢‘é“"
            echo "ä½¿ç”¨åŸå§‹æ–‡ä»¶ä½œä¸ºå¤‡ä»½..."
            cp raw_live.m3u live.m3u
            chmod 664 live.m3u
          fi
          
          # åˆ›å»ºç»Ÿè®¡ä¿¡æ¯æ–‡ä»¶
          echo "ç”Ÿæˆç»Ÿè®¡ä¿¡æ¯..."
          echo "æ›´æ–°æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" > stats.txt
          echo "åŸå§‹é¢‘é“æ•°: $ORIGINAL_COUNT" >> stats.txt
          echo "å«è§†é¢‘é“æ•°: $FILTERED_COUNT" >> stats.txt
          echo "ç­›é€‰å…³é”®è¯: $KEYWORDS" >> stats.txt
          chmod 664 stats.txt
          
        else
          echo "âŒ ç­›é€‰å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹æ–‡ä»¶"
          cp raw_live.m3u live.m3u
          chmod 664 live.m3u
        fi
        
        echo "æœ€ç»ˆæ–‡ä»¶å¤§å°: $(wc -l < live.m3u) è¡Œ"
    
    # æ­¥éª¤4ï¼šåˆ›å»ºåˆ†ç±»æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
    - name: Create categorized files
      run: |
        echo "åˆ›å»ºåˆ†ç±»æ–‡ä»¶..."
        
        # åˆ›å»ºå¤®è§†åˆ†ç±»
        if grep -i -q "CCTV" raw_live.m3u; then
          echo "#EXTM3U" > cctv.m3u
          grep -i "CCTV" -A 1 -B 0 raw_live.m3u >> cctv.m3u
          chmod 664 cctv.m3u
          CCTV_COUNT=$(grep -c "^#EXTINF" cctv.m3u || echo "0")
          echo "å¤®è§†é¢‘é“æ•°: $CCTV_COUNT"
        fi
        
        # åˆ›å»ºåœ°æ–¹å«è§†åˆ†ç±»
        if grep -i -q "å«è§†" raw_live.m3u; then
          echo "#EXTM3U" > local_satellite.m3u
          grep -i "å«è§†" -A 1 -B 0 raw_live.m3u >> local_satellite.m3u
          chmod 664 local_satellite.m3u
          LOCAL_COUNT=$(grep -c "^#EXTINF" local_satellite.m3u || echo "0")
          echo "åœ°æ–¹å«è§†æ•°: $LOCAL_COUNT"
        fi
    
    # æ­¥éª¤5ï¼šé…ç½®Git
    - name: Setup Git
      run: |
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
    
    # æ­¥éª¤6ï¼šæ£€æŸ¥æ–‡ä»¶å˜åŒ–
    - name: Check for changes
      id: check-changes
      run: |
        echo "æ£€æŸ¥æ–‡ä»¶å˜åŒ–..."
        
        # æ£€æŸ¥å“ªäº›æ–‡ä»¶æœ‰å˜åŒ–
        CHANGED_FILES=""
        
        for file in live.m3u raw_live.m3u stats.txt cctv.m3u local_satellite.m3u; do
          if [ -f "$file" ]; then
            if ! git diff --quiet "$file" 2>/dev/null; then
              echo "æ£€æµ‹åˆ° $file æœ‰å˜åŒ–"
              CHANGED_FILES="$CHANGED_FILES $file"
            elif ! git ls-files --error-unmatch "$file" >/dev/null 2>&1; then
              echo "$file æ˜¯æ–°æ–‡ä»¶"
              CHANGED_FILES="$CHANGED_FILES $file"
            fi
          fi
        done
        
        if [ -n "$CHANGED_FILES" ]; then
          echo "changes_detected=true" >> $GITHUB_OUTPUT
          echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
        else
          echo "changes_detected=false" >> $GITHUB_OUTPUT
        fi
        
        echo "å½“å‰GitçŠ¶æ€:"
        git status --short
    
    # æ­¥éª¤7ï¼šæäº¤å¹¶æ¨é€æ›´æ”¹
    - name: Commit and push changes
      if: steps.check-changes.outputs.changes_detected == 'true'
      run: |
        echo "æäº¤æ›´æ”¹..."
        
        # æ·»åŠ æ‰€æœ‰ç›¸å…³æ–‡ä»¶
        git add live.m3u raw_live.m3u stats.txt
        
        # æ·»åŠ åˆ†ç±»æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        [ -f "cctv.m3u" ] && git add cctv.m3u
        [ -f "local_satellite.m3u" ] && git add local_satellite.m3u
        
        # æäº¤æ›´æ”¹
        FILTERED_COUNT=$(grep -c "^#EXTINF" live.m3u || echo "0")
        COMMIT_MESSAGE="æ›´æ–°M3Uæ’­æ”¾åˆ—è¡¨ - ç­›é€‰å‡º$FILTERED_COUNTä¸ªå«è§†é¢‘é“ - $(date '+%Y-%m-%d %H:%M:%S')"
        git commit -m "$COMMIT_MESSAGE"
        
        # æ¨é€åˆ°ä»“åº“
        echo "æ­£åœ¨æ¨é€åˆ°ä»“åº“..."
        git push
        
        echo "âœ… æ›´æ”¹å·²æˆåŠŸæ¨é€ï¼"
    
    # æ­¥éª¤8ï¼šå¦‚æœæ²¡æœ‰å˜åŒ–
    - name: No changes to commit
      if: steps.check-changes.outputs.changes_detected == 'false'
      run: |
        echo "ğŸ“ æ²¡æœ‰æ£€æµ‹åˆ°å˜åŒ–ï¼Œè·³è¿‡æäº¤"
        echo "æ–‡ä»¶çŠ¶æ€:"
        ls -la *.m3u stats.txt 2>/dev/null || echo "æ²¡æœ‰ç›¸å…³æ–‡ä»¶"
    
    # æ­¥éª¤9ï¼šæœ€ç»ˆéªŒè¯
    - name: Final verification
      run: |
        echo "=== å·¥ä½œæµæ‰§è¡Œç»“æœ ==="
        echo "å®Œæˆæ—¶é—´: $(date)"
        
        if [ -f "live.m3u" ]; then
          echo "âœ… live.m3u å·²åˆ›å»º"
          echo "æ–‡ä»¶è¡Œæ•°: $(wc -l < live.m3u)"
          echo "é¢‘é“æ•°é‡: $(grep -c "^#EXTINF" live.m3u || echo "0")"
          echo "æ–‡ä»¶å†…å®¹ç¤ºä¾‹:"
          grep -i "^#EXTINF" live.m3u | head -10
        else
          echo "âŒ live.m3u æœªåˆ›å»º"
        fi
        
        if [ -f "stats.txt" ]; then
          echo "ç»Ÿè®¡ä¿¡æ¯:"
          cat stats.txt
        fi
