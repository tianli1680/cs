name: Download M3U Playlist

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    # æ¯å¤©å‡Œæ™¨3ç‚¹è‡ªåŠ¨æ‰§è¡Œï¼ˆUTCæ—¶é—´ï¼‰
    - cron: '0 3 * * *'
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/download-m3u.yml'

# è®¾ç½®å¿…è¦çš„æƒé™
permissions:
  contents: write  # å…è®¸å†™å…¥ä»“åº“å†…å®¹
  actions: read    # å…è®¸è¯»å–actionsï¼ˆå¯é€‰ï¼‰
  checks: read     # å…è®¸è¯»å–æ£€æŸ¥çŠ¶æ€ï¼ˆå¯é€‰ï¼‰

jobs:
  download-m3u:
    runs-on: ubuntu-latest
    
    # ä¹Ÿå¯ä»¥åœ¨jobçº§åˆ«è®¾ç½®æƒé™
    permissions:
      contents: write  # è¿™ä¸ªjobéœ€è¦å†™å…¥æƒé™
    
    steps:
    - name: Checkout repository with write permissions
      uses: actions/checkout@v4
      with:
        # è·å–æ‰€æœ‰åˆ†æ”¯çš„å†å²è®°å½•
        fetch-depth: 0
        # ä½¿ç”¨å…·æœ‰å†™å…¥æƒé™çš„token
        token: ${{ secrets.GITHUB_TOKEN }}
        # å¦‚æœéœ€è¦æ¨é€åˆ°å…¶ä»–åˆ†æ”¯ï¼Œå¯ä»¥å–æ¶ˆæ³¨é‡Šä¸‹é¢è¿™è¡Œ
        # ref: main
        
    - name: Setup environment
      run: |
        echo "å·¥ä½œæµå¼€å§‹æ—¶é—´: $(date)"
        echo "ä»“åº“: ${{ github.repository }}"
        echo "è§¦å‘è€…: ${{ github.actor }}"
        
    - name: Download M3U playlist
      id: download
      run: |
        echo "æ­£åœ¨ä¸‹è½½ M3U æ’­æ”¾åˆ—è¡¨..."
        
        # ä¸‹è½½ M3U æ–‡ä»¶ï¼Œæ·»åŠ è¶…æ—¶å’Œé‡è¯•æœºåˆ¶
        curl -s -L --max-time 30 --retry 2 \
          "http://zizi.dpdns.org/cs.php?key=Ku0VIKlbNHX9&type=m3u" \
          -o live.m3u
          
        # æ£€æŸ¥ä¸‹è½½æ˜¯å¦æˆåŠŸ
        if [ $? -eq 0 ] && [ -f "live.m3u" ]; then
          echo "âœ… æ–‡ä»¶ä¸‹è½½æˆåŠŸï¼"
          
          # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
          LINE_COUNT=$(wc -l < live.m3u 2>/dev/null || echo "0")
          echo "æ–‡ä»¶è¡Œæ•°: $LINE_COUNT"
          
          # è®¾ç½®æ–‡ä»¶æƒé™ä¸ºè¯»å†™ï¼ˆ664ï¼šrw-rw-r--ï¼‰
          chmod 664 live.m3u
          echo "æ–‡ä»¶æƒé™å·²è®¾ç½®ä¸º 664 (rw-rw-r--)"
          
          # éªŒè¯æƒé™
          echo "å½“å‰æ–‡ä»¶æƒé™:"
          ls -la live.m3u
          
          # åˆ›å»ºè¾“å‡ºå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          # æ˜¾ç¤ºæ–‡ä»¶å‰å‡ è¡Œï¼ˆç”¨äºè°ƒè¯•ï¼‰
          if [ $LINE_COUNT -gt 0 ]; then
            echo "æ–‡ä»¶å†…å®¹é¢„è§ˆï¼ˆå‰3è¡Œï¼‰:"
            head -3 live.m3u
          fi
        else
          echo "âŒ æ–‡ä»¶ä¸‹è½½å¤±è´¥ï¼"
          echo "has_changes=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
    - name: Check for changes
      if: steps.download.outputs.has_changes == 'true'
      id: check-changes
      run: |
        echo "æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–..."
        
        # æ£€æŸ¥gitçŠ¶æ€
        git status
        
        # æ£€æŸ¥live.m3uæ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
        if git diff --name-only | grep -q "live.m3u"; then
          echo "æ£€æµ‹åˆ°live.m3uæœ‰å˜åŒ–"
          echo "file_changed=true" >> $GITHUB_OUTPUT
        else
          echo "live.m3uæ²¡æœ‰å˜åŒ–"
          echo "file_changed=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Configure Git for committing
      if: steps.download.outputs.has_changes == 'true' && steps.check-changes.outputs.file_changed == 'true'
      run: |
        echo "é…ç½®Gitç”¨æˆ·ä¿¡æ¯..."
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        
    - name: Commit and push changes
      if: steps.download.outputs.has_changes == 'true' && steps.check-changes.outputs.file_changed == 'true'
      run: |
        echo "æäº¤æ›´æ”¹åˆ°ä»“åº“..."
        
        # æ·»åŠ æ–‡ä»¶åˆ°æš‚å­˜åŒº
        git add live.m3u
        
        # æäº¤æ›´æ”¹
        COMMIT_MESSAGE="è‡ªåŠ¨æ›´æ–°: M3Uæ’­æ”¾åˆ—è¡¨ [$(date +'%Y-%m-%d %H:%M:%S')]"
        git commit -m "$COMMIT_MESSAGE"
        
        # æ¨é€åˆ°ä»“åº“
        echo "æ­£åœ¨æ¨é€åˆ° ${{ github.ref }}..."
        git push origin HEAD:${{ github.ref_name }}
        
        echo "âœ… æ›´æ”¹å·²æˆåŠŸæäº¤å¹¶æ¨é€ï¼"
        
    - name: Skip commit if no changes
      if: steps.download.outputs.has_changes == 'true' && steps.check-changes.outputs.file_changed == 'false'
      run: |
        echo "ğŸ“ æ–‡ä»¶å†…å®¹æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æäº¤ã€‚"
        echo "å½“å‰live.m3uæ–‡ä»¶å†…å®¹å“ˆå¸Œ:"
        git hash-object live.m3u
        
    - name: Handle download failure
      if: steps.download.outputs.has_changes == 'false'
      run: |
        echo "âŒ ä¸‹è½½å¤±è´¥ï¼Œå·¥ä½œæµç»ˆæ­¢ã€‚"
        exit 1
        
    - name: Final status report
      run: |
        echo "=== å·¥ä½œæµæ‰§è¡Œå®Œæˆ ==="
        echo "å®Œæˆæ—¶é—´: $(date)"
        echo "ä»“åº“: ${{ github.repository }}"
        echo "æ‰§è¡Œç»“æœ: ${{ job.status }}"
