name: Download M3U Playlist

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */5 * * *'

permissions:
  contents: write

jobs:
  filter-satellite-tv:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Download original playlist
      run: |
        echo "ä¸‹è½½åŸå§‹æ’­æ”¾åˆ—è¡¨..."
        curl -s -L "http://zizi.dpdns.org/cs.php?key=Ku0VIKlbNHX9&type=m3u" -o original.m3u
        echo "åŸå§‹æ–‡ä»¶ä¸‹è½½å®Œæˆ"
        
    - name: Filter satellite TV channels
      run: |
        echo "ç­›é€‰å«è§†é¢‘é“..."
        
        # å«è§†å…³é”®è¯ï¼ˆå¯è‡ªè¡Œæ·»åŠ æˆ–ä¿®æ”¹ï¼‰
        SATELLITE_KEYWORDS="CCTV|å«è§†|æ¹–å—å«è§†|æµ™æ±Ÿå«è§†|æ±Ÿè‹å«è§†|ä¸œæ–¹å«è§†|åŒ—äº¬å«è§†"
        
        # åˆ›å»ºæ–°æ–‡ä»¶ï¼Œæ·»åŠ M3Uå¤´
        echo "#EXTM3U" > live.m3u
        
        # ä½¿ç”¨awkç²¾ç¡®ç­›é€‰ï¼Œä¿ç•™å®Œæ•´çš„é¢‘é“ä¿¡æ¯
        awk -v keywords="$SATELLITE_KEYWORDS" '
        BEGIN { RS="#EXTINF"; ORS="#EXTINF"; IGNORECASE=1 }
        $0 ~ keywords { print }
        ' original.m3u | grep -v "^$" >> live.m3u
        
        # å¦‚æœç­›é€‰ç»“æœä¸ºç©ºï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ³•
        if [ ! -s "live.m3u" ] || [ $(wc -l < live.m3u) -le 1 ]; then
          echo "ä½¿ç”¨å¤‡ç”¨ç­›é€‰æ–¹æ³•..."
          echo "#EXTM3U" > live.m3u
          grep -i -E "$SATELLITE_KEYWORDS" -B 1 original.m3u | grep -v "^--$" >> live.m3u
        fi
        
        # è®¾ç½®æ–‡ä»¶æƒé™
        chmod 664 live.m3u
        
        # æ˜¾ç¤ºç»“æœ
        ORIGINAL=$(grep -c "^#EXTINF" original.m3u || echo "0")
        FILTERED=$(grep -c "^#EXTINF" live.m3u || echo "0")
        
        echo "ç­›é€‰å®Œæˆï¼šåŸå§‹é¢‘é“ $ORIGINAL ä¸ªï¼Œå«è§†é¢‘é“ $FILTERED ä¸ª"
        echo "å«è§†é¢‘é“åˆ—è¡¨ï¼š"
        grep -i "^#EXTINF" live.m3u | head -15
    
    - name: Commit and push
      run: |
        git config user.email "actions@github.com"
        git config user.name "GitHub Actions"
        
        git add live.m3u
        
        if ! git diff --cached --quiet; then
          COUNT=$(grep -c "^#EXTINF" live.m3u || echo "0")
          git commit -m "æ›´æ–°å«è§†é¢‘é“åˆ—è¡¨ ($COUNTä¸ªé¢‘é“) - $(date '+%Y-%m-%d %H:%M:%S')"
          git push
          echo "âœ… å·²æäº¤å¹¶æ¨é€"
        else
          echo "ğŸ“ æ²¡æœ‰å˜åŒ–"
        fi
